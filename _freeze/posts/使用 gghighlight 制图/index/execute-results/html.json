{
  "hash": "2becd2bfaadb0cefc484e8cb408c01ce",
  "result": {
    "markdown": "---\ntitle: \"使用 gghighlight 制图\"\ncategories: [R, ggplot2]\ndate: '2023/08/06'\nexecute:\n  warning: false\n---\n\n\n## 包引入\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(gghighlight)\nlibrary(hrbrthemes)\n```\n:::\n\n\n## 数据准备和清洗\n\n先导入数据。\n\n\n::: {.cell}\n\n```{.r .cell-code}\njisu_apps <- readxl::read_xlsx(\"QM数据.xlsx\", sheet = 3) \n```\n:::\n\n\njisu_apps数据集中是不同极速版App的月活变化数据。\n\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::kable(head(jisu_apps))\n```\n\n::: {.cell-output-display}\n|时间       | 快手极速版| 抖音极速版| 爱奇艺极速版| 喜马拉雅极速版| 好看视频极速版| 火山极速版| 美团极速版| QQ极速版| 腾讯视频极速版|\n|:----------|----------:|----------:|------------:|--------------:|--------------:|----------:|----------:|--------:|--------------:|\n|2020-01-01 |   10703.60|    9024.61|           NA|          89.47|             NA|    3387.60|         NA|   274.50|         537.34|\n|2020-02-01 |   11374.78|    7565.89|           NA|         171.90|             NA|    2274.78|         NA|   351.04|         584.78|\n|2020-03-01 |   11018.65|    6699.28|           NA|         165.85|             NA|    1487.27|         NA|   322.12|         425.26|\n|2020-04-01 |   11237.10|    7222.69|           NA|         108.06|             NA|    1273.40|         NA|   287.80|         327.93|\n|2020-05-01 |   11655.08|    7979.54|           NA|          92.20|             NA|    1350.78|         NA|   236.04|         290.39|\n|2020-06-01 |   12118.11|    8839.93|           NA|         101.82|             NA|    2139.89|         NA|   219.02|         254.15|\n:::\n:::\n\n\n绘图需使用长数据，我们先将宽数据转换为长数据。\n\n\n::: {.cell}\n\n```{.r .cell-code}\njisu_apps_long <- jisu_apps %>%\n  pivot_longer(cols = 2:10, names_to = \"应用\", values_to = \"月活\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::kable(head(jisu_apps_long))\n```\n\n::: {.cell-output-display}\n|时间       |应用           |     月活|\n|:----------|:--------------|--------:|\n|2020-01-01 |快手极速版     | 10703.60|\n|2020-01-01 |抖音极速版     |  9024.61|\n|2020-01-01 |爱奇艺极速版   |       NA|\n|2020-01-01 |喜马拉雅极速版 |    89.47|\n|2020-01-01 |好看视频极速版 |       NA|\n|2020-01-01 |火山极速版     |  3387.60|\n:::\n:::\n\n\n## 使用 gghighlight 制图\n\n其实整个pacakge里主要使用的就是`gghighlight()`函数。\n\n先看没有高亮任一线条的样子。\n\n\n::: {.cell}\n\n```{.r .cell-code}\njisu_apps_long %>%\n  ggplot(aes(x = 时间, y = 月活)) +\n  geom_line(aes(group = 应用, color = 应用)) +\n  theme_ipsum(base_family = \"PingFang SC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n再来高亮指定名称的线条。其中`label_params`主要用来调整高亮线条的名称样式，参数和`geom_label_repel`一致。\n\n\n::: {.cell}\n\n```{.r .cell-code}\njisu_apps_long %>%\n  ggplot(aes(x = 时间, y = 月活)) +\n  geom_line(aes(group = 应用, color = 应用)) +\n  gghighlight(应用 == '快手极速版', label_params = list(family = \"PingFang SC\")) +\n  theme_ipsum(base_family = \"PingFang SC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n线条名称可以改用图例的形式，而不直接在线条结尾处展现标签。这里需使用`use_direct_label`参数。\n\n\n::: {.cell}\n\n```{.r .cell-code}\njisu_apps_long %>%\n  ggplot(aes(x = 时间, y = 月活)) +\n  geom_line(aes(group = 应用, color = 应用)) +\n  gghighlight(应用 == '快手极速版', use_direct_label = FALSE) +\n  theme_ipsum(base_family = \"PingFang SC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n还可以使用函数筛选需要高亮的线条。例如通过`max(月活) > 10000`筛选出月活过亿的应用。\n\n\n::: {.cell}\n\n```{.r .cell-code}\njisu_apps_long %>%\n  ggplot(aes(x = 时间, y = 月活)) +\n  geom_line(aes(group = 应用, color = 应用)) +\n  gghighlight(max(月活) > 10000, use_direct_label = FALSE) +\n  theme_ipsum(base_family = \"PingFang SC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n结合`max_highlight`参数，指定高亮的最大线条数。\n\n\n::: {.cell}\n\n```{.r .cell-code}\njisu_apps_long %>%\n  ggplot(aes(x = 时间, y = 月活)) +\n  geom_line(aes(group = 应用, color = 应用)) +\n  gghighlight(max(月活, na.rm = TRUE), max_highlight = 3, use_direct_label = FALSE) +\n  theme_ipsum(base_family = \"PingFang SC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n如果有更细粒度的需求，例如2023年月活最高的三个应用，则无法通过`gghighlight()`内置参数直接实现，需要先计算得到这三个应用的名称。\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntop3_app_names <- jisu_apps_long %>%\n  filter(lubridate::year(时间) == 2023) %>%\n  group_by(应用) %>%\n  top_n(1, 月活) %>%\n  ungroup() %>%\n  arrange(desc(月活)) %>%\n  top_n(3, 月活) %>%\n  pull(应用)\n\n# 也可使用行计算，结果和上面一样\n# top3_app_names2 <- jisu_apps_long %>%\n#   filter(lubridate::year(时间) == 2023) %>%\n#   pivot_wider(names_from = 时间, values_from = 月活) %>%\n#   rowwise() %>%\n#   mutate(最大月活 = max(across(where(is.numeric)))) %>%\n#   ungroup() %>%\n#   top_n(3, 最大月活) %>%\n#   pull(应用)\n  \njisu_apps_long %>%\n  ggplot(aes(x = 时间, y = 月活)) +\n  geom_line(aes(group = 应用, color = 应用)) +\n  gghighlight(应用 %in% top3_app_names, use_direct_label = FALSE) +\n  theme_ipsum(base_family = \"PingFang SC\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n最后按应用进行分面。\n\n\n::: {.cell}\n\n```{.r .cell-code}\njisu_apps_long %>%\n  mutate(应用 = fct_reorder(应用, -月活, mean, na.rm = TRUE)) %>%\n  ggplot(aes(x = 时间, y = 月活)) +\n  geom_line(aes(group = 应用, color = 应用), size = 0.7) +\n  # 为了看清趋势采用对数坐标轴\n  scale_y_log10() +\n  theme_ipsum(base_family = \"PingFang SC\", grid = \"XY\") +\n  gghighlight(use_direct_label = FALSE) +\n  facet_wrap(~应用) +\n  guides(color = FALSE) +\n  labs(y = \"月活（万人）\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n## 参考资料\n\n-   [Introduction to gghighlight](https://cran.r-project.org/web/packages/gghighlight/vignettes/gghighlight.html)\n\n-   [Line chart with small multiple](https://r-graph-gallery.com/web-line-chart-small-multiple-all-group-greyed-out.html)\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}